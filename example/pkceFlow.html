
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKCE OAuth Flow</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        .token-container {
            margin-top: 20px;
            display: none;
        }
        .token-field {
            margin-bottom: 15px;
        }
        .token-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .token-field .value {
            padding: 8px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            word-break: break-all;
        }
        .access-token-container {
            position: relative;
        }
        .token-textbox {
            width: calc(100% - 70px);
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .copy-btn {
            position: absolute;
            right: 0;
            top: 0;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
        }
        .copy-btn:hover {
            background-color: #0b7dda;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
    </style>
</head>
<body>
<h1>PKCE OAuth Flow Beispiel</h1>

<div class="container">
    <p>Klicke auf den Button, um den OAuth-PKCE-Flow zu starten:</p>
    <button id="loginBtn">Login starten</button>

    <div id="statusMessage" class="status" style="display: none;"></div>
</div>

<div id="tokenContainer" class="token-container">
    <h2>Token Information</h2>

    <div class="token-field access-token-container">
        <label for="accessTokenBox">Access Token:</label>
        <input type="text" id="accessTokenBox" class="token-textbox" readonly>
        <button id="copyBtn" class="copy-btn">Kopieren</button>
    </div>

    <div class="token-field">
        <label>Token Type:</label>
        <div id="tokenType" class="value"></div>
    </div>

    <div class="token-field">
        <label>Expires In (Sekunden):</label>
        <div id="expiresIn" class="value"></div>
    </div>
</div>

<script>
    const authorizeEndpoint = "https://cirqit-dev-auth-344019372375.auth.eu-central-1.amazoncognito.com/login";
    const tokenEndpoint = "https://cirqit-dev-auth-344019372375.auth.eu-central-1.amazoncognito.com/oauth2/token";
    const clientId = "57mp30e89p3q876aea8rnhqs46";
    const BACKEND_SERVER = "https://api-dev.cirqit.cloud/oauth2/token";


    // PKCE Funktionen
    function generateCodeVerifier() {
        const array = new Uint8Array(32);
        window.crypto.getRandomValues(array);
        return base64UrlEncode(array);
    }

    function base64UrlEncode(buffer) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
    }

    async function generateCodeChallenge(codeVerifier) {
        const encoder = new TextEncoder();
        const data = encoder.encode(codeVerifier);
        const digest = await window.crypto.subtle.digest('SHA-256', data);
        return base64UrlEncode(digest);
    }

    // Starte den Login-Prozess
    async function startLogin() {
        try {
            // Status zurücksetzen
            document.getElementById('statusMessage').style.display = 'none';
            document.getElementById('tokenContainer').style.display = 'none';

            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);

            // Generiere einen zufälligen State für CSRF-Schutz
            const state = base64UrlEncode(window.crypto.getRandomValues(new Uint8Array(16)));

            // Speichere den Code Verifier und State für später
            localStorage.setItem('codeVerifier', codeVerifier);
            localStorage.setItem('pkceState', state);

            // Redirect zum Authorization Server
            // WICHTIG: Passe diese URL entsprechend deines Authorization Servers an
            const authUrl = authorizeEndpoint+`?` +
                `client_id=` + clientId +
                `&response_type=code` +
                `&code_challenge=${codeChallenge}` +
                `&code_challenge_method=S256` +
                `&state=${state}` +
                `&redirect_uri=` + BACKEND_SERVER;

            console.log("set location to "+authUrl)
            window.location = authUrl;

        } catch (error) {
            showError('Fehler beim Start des Login-Prozesses: ' + error.message);
        }
    }


//
//
//     // Nach dem Redirect vom Authorization Server
//     async function handleRedirect() {
//
//         console.log(">>>>>>>>>>>> handle redirect -----------------------")
//
//         const urlParams = new URLSearchParams(window.location.search);
//         const code = urlParams.get('code');
//
//         if (code) {
//             try {
//                 // Status-Info anzeigen (optional)
//                 showStatus('Verarbeite Authentication Code...');
//
//                 // Hole den gespeicherten Code Verifier
//                 const codeVerifier = localStorage.getItem('codeVerifier');
//
//                 if (!codeVerifier) {
//                     showError('Code Verifier nicht gefunden. Bitte versuche es erneut.');
//                     return;
//                 }
//
//                 // Token-Austausch direkt im Browser durchführen
//                 const tokenResponse = await fetch('https://auth-server.com/token', {
//                     method: 'POST',
//                     headers: {
//                         'Content-Type': 'application/x-www-form-urlencoded'
//                     },
//                     body: new URLSearchParams({
//                         'client_id': 'YOUR_CLIENT_ID',
//                         'grant_type': 'authorization_code',
//                         'code': code,
//                         'code_verifier': codeVerifier,
//                         'redirect_uri': window.location.origin + window.location.pathname
//                     })
//                 });
//
//
//
//                 if (!tokenResponse.ok) {
//                     const errorData = await tokenResponse.json().catch(() => ({}));
//                     console.error("tokenResponse not ok "+errorData)
//                     return
// //                    throw new Error(errorData.error_description || errorData.error || `Server-Fehler: ${tokenResponse.status}`);
//                 }
//
//                 const tokenData = await tokenResponse.json();
//
//                 // Token im localStorage oder sessionStorage speichern (optional)
//                 localStorage.setItem('access_token', tokenData.access_token);
//
//                 // Entferne die Parameter aus der URL ohne Neuladen der Seite
//                 window.history.replaceState({}, document.title, window.location.pathname);
//
//                 // Token auf der Seite anzeigen
//                 displayTokenInfo(tokenData);
//
//                 showSuccess('Authentifizierung erfolgreich!');
//             } catch (error) {
//                 showError('Fehler beim Token-Austausch: ' + error.message);
//             }
//         }
//     }

    // Hilfsfunktionen für die Statusanzeige (falls noch nicht vorhanden)
    function showStatus(message) {
        const statusElement = document.getElementById('statusMessage') || createStatusElement();
        statusElement.textContent = message;
        statusElement.className = 'status';
        statusElement.style.display = 'block';
    }

    function showError(message) {
        const statusElement = document.getElementById('statusMessage') || createStatusElement();
        statusElement.textContent = message;
        statusElement.className = 'status error';
        statusElement.style.display = 'block';
    }

    function showSuccess(message) {
        const statusElement = document.getElementById('statusMessage') || createStatusElement();
        statusElement.textContent = message;
        statusElement.className = 'status success';
        statusElement.style.display = 'block';
    }

    // Hilfsfunktion für die Tokendarstellung (falls noch nicht vorhanden)
    function displayTokenInfo(data) {
        const tokenContainer = document.getElementById('tokenContainer') || createTokenContainer();

        const accessTokenBox = document.getElementById('accessTokenBox');
        if (accessTokenBox) accessTokenBox.value = data.access_token || 'Nicht verfügbar';

        const tokenType = document.getElementById('tokenType');
        if (tokenType) tokenType.textContent = data.token_type || 'Nicht verfügbar';

        const expiresIn = document.getElementById('expiresIn');
        if (expiresIn) expiresIn.textContent = data.expires_in || 'Nicht verfügbar';

        tokenContainer.style.display = 'block';
    }

    // Hilfsfunktion zum Erstellen eines Status-Elements (falls noch nicht vorhanden)
    function createStatusElement() {
        const statusElement = document.createElement('div');
        statusElement.id = 'statusMessage';
        statusElement.className = 'status';
        document.body.appendChild(statusElement);
        return statusElement;
    }

    // Hilfsfunktion zum Erstellen eines Token-Containers (falls noch nicht vorhanden)
    function createTokenContainer() {
        const container = document.createElement('div');
        container.id = 'tokenContainer';
        container.className = 'token-container';
        document.body.appendChild(container);
        return container;
    }

    // // Führe den handleRedirect bei Seitenladung aus
    // document.addEventListener('DOMContentLoaded', handleRedirect);

    // // Nach dem Redirect: Verarbeite den Auth Code
    function handleRedirect() {
        console.error("handle redirect !!!!!!!!¨¨¨¨")
    }
    //     const urlParams = new URLSearchParams(window.location.search);
    //     const code = urlParams.get('code');
    //     const state = urlParams.get('state');
    //     const error = urlParams.get('error');
    //     const storedState = localStorage.getItem('pkceState');
    //
    //     // Entferne die Parameter aus der URL ohne Neuladen der Seite
    //     window.history.replaceState({}, document.title, window.location.pathname);
    //
    //     if (error) {
    //         showError('Authentifizierungsfehler: ' + error);
    //         return;
    //     }
    //
    //     if (!code) {
    //         return; // Kein Code, wahrscheinlich der erste Besuch
    //     }
    //
    //     // Überprüfe den State zur Vermeidung von CSRF-Angriffen
    //     if (state !== storedState) {
    //         showError('Sicherheitsfehler: Ungültiger State-Parameter');
    //         return;
    //     }
    //
    //     // Hole den gespeicherten Code Verifier
    //     const codeVerifier = localStorage.getItem('codeVerifier');
    //
    //     if (!codeVerifier) {
    //         showError('Code Verifier nicht gefunden. Bitte versuche es erneut.');
    //         return;
    //     }
    //
    //     // Sende Code und Code Verifier an den Backend-Server
    //     exchangeCodeForToken(code, codeVerifier);
    // }

    // Sende Auth Code und Code Verifier an den Backend-Server
    async function exchangeCodeForToken(code, codeVerifier) {
        try {
            const body = JSON.stringify({
                code,
                codeVerifier,
                redirectUri: window.location.origin + window.location.pathname
            })
            console.log("body: ", body)

            // WICHTIG: Passe diese URL entsprechend deines Backend-Servers an
            const response = await fetch(BACKEND_SERVER, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: body
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error_description || errorData.error || 'Server-Fehler');
            }

            const data = await response.json();
            displayTokenInfo(data);

            // Lösche sensible Daten aus dem localStorage
            localStorage.removeItem('codeVerifier');
            localStorage.removeItem('pkceState');

            showSuccess('Authentifizierung erfolgreich!');
        } catch (error) {
            showError('Fehler beim Token-Austausch: ' + error.message);
        }
    }

    // UI-Funktionen
    function displayTokenInfo(data) {
        const tokenContainer = document.getElementById('tokenContainer');
        const accessTokenBox = document.getElementById('accessTokenBox');
        const tokenType = document.getElementById('tokenType');
        const expiresIn = document.getElementById('expiresIn');

        accessTokenBox.value = data.access_token || 'Nicht verfügbar';
        tokenType.textContent = data.token_type || 'Nicht verfügbar';
        expiresIn.textContent = data.expires_in || 'Nicht verfügbar';

        tokenContainer.style.display = 'block';
    }

    function showError(message) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = message;
        statusMessage.className = 'status error';
        statusMessage.style.display = 'block';
    }

    function showSuccess(message) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = message;
        statusMessage.className = 'status success';
        statusMessage.style.display = 'block';
    }

    // Kopier-Funktion für den Access Token
    function copyAccessToken() {
        const accessTokenBox = document.getElementById('accessTokenBox');
        accessTokenBox.select();
        document.execCommand('copy');

        const copyBtn = document.getElementById('copyBtn');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = 'Kopiert!';

        setTimeout(() => {
            copyBtn.textContent = originalText;
        }, 2000);
    }

    // Event-Listener
    document.getElementById('loginBtn').addEventListener('click', startLogin);
    document.getElementById('copyBtn').addEventListener('click', copyAccessToken);

    // // Prüfe beim Laden der Seite, ob es sich um einen Redirect handelt
    window.addEventListener('DOMContentLoaded', handleRedirect);
    //
    // document.addEventListener('DOMContentLoaded', () => {
    //     const urlParams = new URLSearchParams(window.location.search);
    //     if (urlParams.has('code')) {
    //         handleRedirect();
    //     }
    // });
    //
    // // Prüfe beim Laden der Seite, ob es sich um einen Redirect handelt
    // window.addEventListener('DOMContentLoaded', () => {
    //     if (window.location.pathname === '/oauth2/token') {
    //         console.error("handle redirect for oauth2/token")
    //         handleRedirect();
    //     }
    // })
</script>
</body>
</html>
